<!DOCTYPE html>
<html>
    <head>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Stick+No+Bills:wght@200..800&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Overpass:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet"
        />

        <style>
            body {
                background-color: #333333;
            }

            .title {
                color: yellow;
                text-align: center;
            }

            .parking-lot {
                min-height: 200px;
                display: flex;
            }

            .parking-space {
                width: 100px;
                color: yellow;
                text-align: center;
                font-size: 80px;
                font-family: "Stick No Bills", sans-serif;
                font-optical-sizing: auto;
                font-weight: 700;
                font-style: bold;
            }

            .parking-line {
                width: 12px;
                background-color: yellow;
                border-radius: 3px;
            }

            .sign {
                break-after: auto;
                width: 160px;
                border: 2px solid white;
                border-radius: 8px;
                font-family: "Overpass", sans-serif;
                font-size: 30px;
                text-align: center;
                line-break: auto;
                padding: 6px;
                background-color: green;
                margin-right: 18px;
            }

            .sign-top {
                background-color: green;
                border-radius: 8px;
                height: 40%;
                color: white;
            }

            .sign-bottom {
                background-color: white;
                border-radius: 8px;
                padding-top: 16px;
                color: green;
                font-size: 72px;
            }

            .timestamp {
                font-size: 10px;
                color: white;
                font-family: "Overpass", sans-serif;
            }
        </style>
    </head>
    <body>
        <div class="parking-lot">
            <div class="sign">
                <div class="sign-top">
                    RESERVED PARKING
                </div>
                <div class="sign-bottom">
                    <i class="bi bi-ev-station-fill"></i>
                </div>
            </div>

            <div class="parking-line"></div>

            <div class="parking-space">
                1
                <br />
                <i id="spot1"></i>
                <br />
                <div id="spot1_timestamp" class="timestamp"></div>
            </div>

            <div class="parking-line"></div>

            <div class="parking-space">
                2
                <br />
                <i id="spot2"></i>
                <br />
                <div id="spot2_timestamp" class="timestamp"></div>
            </div>

            <div class="parking-line"></div>

            <div class="parking-space">
                3
                <br />
                <i id="spot3"></i>
                <br />
                <div id="spot3_timestamp" class="timestamp"></div>
            </div>

            <div class="parking-line"></div>

            <div class="parking-space">
                4
                <br />
                <i id="spot4"></i>
                <br />
                <div id="spot4_timestamp" class="timestamp"></div>
            </div>

            <div class="parking-line"></div>
        </div>
    </body>

    <script type="text/javascript">
        let appVersion = null;
        let lastMessageTimestamp = 0;
        const protocol = window.location.protocol == "https:" ? "wss" : "ws";
        const socket = new WebSocket(
            protocol + "://" + window.location.hostname + ":" +
                window.location.port + "/ws",
        );
        socket.addEventListener("message", (event) => {
            lastMessageTimestamp = Date.now();
            try {
                if (event.data.includes("pong-")) {
                    const currentAppVersion = event.data.split("-")[1];
                    if (appVersion == null) {
                        appVersion = currentAppVersion;
                    }
                    if (appVersion != currentAppVersion) {
                        console.log(
                            "Server-reported app version changed from " +
                                appVersion + " to " + currentAppVersion +
                                ", restarting.",
                        );
                        reloadPage(5);
                    }
                    return;
                }

                for (const spot of JSON.parse(event.data)) {
                    let iconClass = "bi bi-x-square";
                    let iconStyle = "color: red;";

                    if (spot.status == "unoccupied") {
                        iconClass = "bi bi-check2-square";
                        iconStyle = "color: green;";
                    }

                    document.getElementById(spot.id).className = iconClass;
                    document.getElementById(spot.id).style = iconStyle;

                    try {
                        document.getElementById(spot.id + "_timestamp").innerText =
                            new Date(spot.timestamp).toLocaleTimeString();
                    } catch (error) {
                        console.error(error);
                    }
                }
            } catch (error) {
                console.log(error);
            }
        });

        //  Keep this thing running.
        //  We reload on...
        //      socket.onclose
        //      last message timestamp > 5 minutes
        //          pings every minute
        //      app version changed
        //

        //  Reload the page when the websocket is closed
        socket.onclose = () => {
            console.log(new Date().toJSON() + " - Connection closed");
            reloadPage(5);
        };

        //  Send a ping every minute
        window.setInterval(() => {
            try {
                socket.send("ping");
            } catch (e) {
                console.error(e);
                reloadPage(5);
            }
        }, 1000 * 60 * 1);

        //  Check if we're alive every 5 minutes
        //  If not, reload the page
        window.setInterval(() => {
            if (Date.now() - lastMessageTimestamp > 5 * 60 * 1000) {
                reloadPage(5);
            }
        }, 1000 * 60 * 5);

        const reloadPage = (durationSeconds) => {
            window.setTimeout(() => {
                window.location.reload();
            }, 1000 * durationSeconds);
        };
    </script>
</html>
